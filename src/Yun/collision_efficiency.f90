    program collision_efficiency

    ! Collision efficiency
    ! Refer to Bott(1998). ─┬─ Davis(1972) and Jonas(1972) (radius <= 25um)
    !                       └─  Hall(1980)                 (radius >= 25um)

    integer, parameter  :: nbin=100
    integer :: i, j, k, kk, ir, iq

    double precision, dimension(nbin,nbin)  :: col_eff
    double precision, dimension(15)         :: radii
    double precision, dimension(21)         :: ratio
    double precision, dimension(15,21)      :: ecoll 
    double precision, dimension(nbin)       :: radius
    double precision  :: rr       ! Radius Ratio
    double precision  :: p, q, ek

!{{{    
    open(10, file="./radius.txt")
    do i = 1, nbin
        read(10,*) radius(i)
    enddo
    radius = radius*1e6
!}}}

    ratio = (/0.,0.05,0.1,0.15,0.2,0.25,0.3,0.35,0.4,0.45,0.5,0.55,0.6,0.65,0.7,0.75,0.8,0.85,0.9,0.95,1.0/)
    radii = (/6.,8.,10.,15.,20.,25.,30.,40.,50.,60.,70.,100.,150.,200.,300./) 
    ecoll = reshape(&
            (/ 0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,0.001,&
               0.003,0.003,0.003,0.004,0.005,0.005,0.005,0.010,0.100,0.050,0.200,0.500,0.770,0.870,0.970,&
               0.007,0.007,0.007,0.008,0.009,0.010,0.010,0.070,0.400,0.430,0.580,0.790,0.930,0.960,1.000,&
               0.009,0.009,0.009,0.012,0.015,0.010,0.020,0.280,0.600,0.640,0.750,0.910,0.970,0.980,1.000,&
               0.014,0.014,0.014,0.015,0.016,0.030,0.060,0.500,0.700,0.770,0.840,0.950,0.970,1.000,1.000,&
               0.017,0.017,0.017,0.020,0.022,0.060,0.100,0.620,0.780,0.840,0.880,0.950,1.000,1.000,1.000,&
               0.030,0.030,0.024,0.022,0.032,0.062,0.200,0.680,0.830,0.870,0.900,0.950,1.000,1.000,1.000,&
               0.025,0.025,0.025,0.036,0.043,0.130,0.270,0.740,0.860,0.890,0.920,1.000,1.000,1.000,1.000,&
               0.027,0.027,0.027,0.040,0.052,0.200,0.400,0.780,0.880,0.900,0.940,1.000,1.000,1.000,1.000,&
               0.030,0.030,0.030,0.047,0.064,0.250,0.500,0.800,0.900,0.910,0.950,1.000,1.000,1.000,1.000,&
               0.040,0.040,0.033,0.037,0.068,0.240,0.550,0.800,0.900,0.910,0.950,1.000,1.000,1.000,1.000,&
               0.035,0.035,0.035,0.055,0.079,0.290,0.580,0.800,0.900,0.910,0.950,1.000,1.000,1.000,1.000,&
               0.037,0.037,0.037,0.062,0.082,0.290,0.590,0.780,0.900,0.910,0.950,1.000,1.000,1.000,1.000,&
               0.037,0.037,0.037,0.060,0.080,0.290,0.580,0.770,0.890,0.910,0.950,1.000,1.000,1.000,1.000,&
               0.037,0.037,0.037,0.041,0.075,0.250,0.540,0.760,0.880,0.920,0.950,1.000,1.000,1.000,1.000,&
               0.037,0.037,0.037,0.052,0.067,0.250,0.510,0.770,0.880,0.930,0.970,1.000,1.000,1.000,1.000,&
               0.037,0.037,0.037,0.047,0.057,0.250,0.490,0.770,0.890,0.950,1.000,1.000,1.000,1.000,1.000,&
               0.036,0.036,0.036,0.042,0.048,0.230,0.470,0.780,0.920,1.000,1.020,1.020,1.020,1.020,1.020,&
               0.040,0.040,0.035,0.033,0.040,0.112,0.450,0.790,1.010,1.030,1.040,1.040,1.040,1.040,1.040,&
               0.033,0.033,0.033,0.033,0.033,0.119,0.470,0.950,1.300,1.700,2.300,2.300,2.300,2.300,2.300,&
               0.027,0.027,0.027,0.027,0.027,0.125,0.520,1.400,2.300,3.000,4.000,4.000,4.000,4.000,4.000/),&
            shape(ecoll))
    
    ! Two-dimensional linear interpolation of the collision efficiency

    do  j = 1, nbin
    do  i = 1, j
        do  k  = 2, 15
            if (( radius(j).ge.radii(k-1) ) .and. ( radius(j).le.radii(k) )) then
                ir=k
            elseif (radius(j).gt.radii(15)) then
                ir=16
            elseif (radius(j).lt.radii(1) ) then
                ir=1
            endif
        enddo

        rr = radius(i) / radius(j)

        do kk = 2, 21
            if (( rr.gt.ratio(kk-1) ) .and. ( rr.le.ratio(kk) )) iq = kk
        enddo
        if ( ir.lt.16 ) then
            if ( ir.ge.2 ) then
                p = ( radius(j)-radii(ir-1) ) / ( radii(ir)-radii(ir-1) )
                q = ( rr-ratio(iq-1) ) / ( ratio(iq)-ratio(iq-1) )
                col_eff(j,i) = (1.-p) * (1.-q) * ecoll(ir-1,iq-1) &
                             +     p  * (1.-q) * ecoll(ir  ,iq-1) &
                             + (1.-p) *     q  * ecoll(ir-1,iq  ) &
                             +     p  *     q  * ecoll(ir  ,iq  )
            else
                q = ( rr-ratio(iq-1) ) / ( ratio(iq)-ratio(iq-1) )
                col_eff(j,i)= (1.-q)*ecoll(1,iq-1) + q*ecoll(1,iq)
           endif
        else
            q  = ( rr-ratio(iq-1) ) / ( ratio(iq)-ratio(iq-1) )
            ek = (1.-q)*ecoll(15,iq-1) + q*ecoll(15,iq)
            col_eff(j,i) = min(ek,1.d0)
        endif
        col_eff(i,j) = col_eff(j,i)
        if (col_eff(i,j).lt.1.e-20) stop 99
    enddo
    enddo
 
    do i = 1, nbin
    do j = 1, nbin
    !    print*, i, j, col_eff(i,j)
    enddo
    enddo
print*, size(radii)

    end program
